{% extends "admin/base_site.html" %}
{% load i18n admin_urls static %}

{% block content %}
<div class="app-productplant seed-records" style="padding: 1em;">
  {# Django messages #}
  {% if messages %}
    <ul class="messagelist">
      {% for message in messages %}
        <li class="{{ message.tags }}">{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  {# Plant chooser / information #}
  {% if is_superuser %}
    <form method="get" class="admin-form" style="margin-bottom:1em;">
      <label for="id_plant">{% trans "Select target plant" %}:</label>
      <select name="plant" id="id_plant">
        <option value="">{% trans "Choose a plant" %}</option>
        {% for p in plants %}
          <option value="{{ p.pk }}" {% if selected_plant and selected_plant.pk == p.pk %}selected{% endif %}>{{ p }}</option>
        {% endfor %}
      </select>

      <input type="text" name="q" placeholder="{% trans 'Search code or name' %}" value="{{ q|default:'' }}" style="margin-left: .5em;" />

      <select name="product_group" style="margin-left: .5em;">
        <option value="">{% trans "All groups" %}</option>
        {% for g in filter_product_groups %}
          <option value="{{ g }}" {% if applied_filters.product_group == g %}selected{% endif %}>{{ g }}</option>
        {% endfor %}
      </select>

      <select name="style_group" style="margin-left: .5em;">
        <option value="">{% trans "All styles" %}</option>
        {% for s in filter_style_groups %}
          <option value="{{ s }}" {% if applied_filters.style_group == s %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>

      <select name="uom" style="margin-left: .5em;">
        <option value="">{% trans "All UoM" %}</option>
        {% for u in filter_uoms %}
          <option value="{{ u }}" {% if applied_filters.uom == u %}selected{% endif %}>{{ u }}</option>
        {% endfor %}
      </select>

      <select name="active" style="margin-left: .5em;">
        <option value="">{% trans "Any status" %}</option>
        <option value="true" {% if applied_filters.active == 'true' %}selected{% endif %}>{% trans "Active" %}</option>
        <option value="false" {% if applied_filters.active == 'false' %}selected{% endif %}>{% trans "Inactive" %}</option>
      </select>

      <button type="submit" class="button" style="margin-left:.5em;">{% trans "Filter" %}</button>
    </form>
  {% else %}
    <p>{% blocktrans with plant=selected_plant %}You will seed into plant: {{ plant }}{% endblocktrans %}</p>
  {% endif %}

  {# If products_page exists, render table + form. Otherwise show helpful note #}
  {% if products_page %}
    <form id="seed-form" method="post" action="">
      {% csrf_token %}
      {# Hidden plant field for POSTs #}
      {% if selected_plant %}
        <input type="hidden" name="plant" value="{{ selected_plant.pk }}" />
      {% endif %}

      <div style="display:flex; align-items:center; gap:.75rem; margin-bottom:.75rem;">
        <label style="display:inline-flex; align-items:center;">
          <input id="select-all-matching" type="checkbox" name="select_all_matching" value="1" />
          <span style="margin-left:.4rem;">{% trans "Select all matching products (server-side)" %}</span>
        </label>

        <input type="hidden" name="select_all" id="select_all_input" value="0" />

        <button id="seed-btn" class="button" type="submit" name="action" value="seed" disabled>{% trans "Seed Selected" %}</button>
        <button id="download-btn" class="button" type="submit" name="download" value="1" disabled>{% trans "Seed & Download report (CSV)" %}</button>

        <div style="margin-left: 1rem; color: #444;">
          <strong>{{ products_count }}</strong> {% trans "missing products" %}
        </div>
      </div>

      <table class="adminlist" style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="width:2em; text-align:center;"><input type="checkbox" id="select-all" /></th>
            <th>{% trans "Code" %}</th>
            <th>{% trans "Name" %}</th>
            <th>{% trans "Shade" %}</th>
            <th>{% trans "Size" %}</th>
            <th>{% trans "Product Group" %}</th>
            <th>{% trans "Style Group" %}</th>
            <th>{% trans "UoM" %}</th>
            <th>{% trans "Std cost" %}</th>
            <th>{% trans "Active" %}</th>
          </tr>
        </thead>
        <tbody>
          {% for product in products_page.object_list %}
            <tr class="{% cycle 'row1' 'row2' %}">
              <td style="text-align:center;">
                <input type="checkbox" class="row-checkbox" name="selected_pks" value="{{ product.pk }}" />
              </td>
              <td>{{ product.code }}</td>
              <td>{{ product.name }}</td>
              <td>{{ product.shade }}</td>
              <td>{{ product.size }}</td>
              <td>{{ product.product_group }}</td>
              <td>{{ product.style_group }}</td>
              <td>{{ product.uom }}</td>
              <td>{{ product.standard_cost }}</td>
              <td style="text-align:center;">{% if product.active %}âœ”{% endif %}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

      {# Pagination controls #}
      <div class="paginator" style="margin-top: .75rem;">
        {% if paginator and paginator.num_pages > 1 %}
          <div style="display:flex; align-items:center; gap: .5rem;">
            {% if products_page.has_previous %}
              <a class="button" href="?page={{ products_page.previous_page_number }}{% if request.GET.plant %}&plant={{ request.GET.plant }}{% endif %}{% if q %}&q={{ q }}{% endif %}">{% trans "previous" %}</a>
            {% endif %}
            <span>{% trans "Page" %} {{ products_page.number }} {% trans "of" %} {{ paginator.num_pages }}</span>
            {% if products_page.has_next %}
              <a class="button" href="?page={{ products_page.next_page_number }}{% if request.GET.plant %}&plant={{ request.GET.plant }}{% endif %}{% if q %}&q={{ q }}{% endif %}">{% trans "next" %}</a>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </form>

    {# Simple client-side UX: select-all + enable/disable seed buttons #}
    <script>
      (function(){
        const selectAllBox = document.getElementById('select-all');
        const rowCheckboxes = Array.from(document.querySelectorAll('.row-checkbox'));
        const seedBtn = document.getElementById('seed-btn');
        const downloadBtn = document.getElementById('download-btn');
        const selectAllMatching = document.getElementById('select-all-matching');
        const selectAllInput = document.getElementById('select_all_input');

        function updateButtons() {
          const anyChecked = rowCheckboxes.some(cb => cb.checked);
          // If select-all-matching is checked, we allow buttons regardless of per-row checkbox state
          const allow = selectAllMatching && selectAllMatching.checked ? true : anyChecked;
          seedBtn.disabled = !allow;
          downloadBtn.disabled = !allow;
        }

        // toggle all per-page checkboxes when page-level select-all clicked
        if (selectAllBox) {
          selectAllBox.addEventListener('change', function(){
            rowCheckboxes.forEach(cb => cb.checked = selectAllBox.checked);
            updateButtons();
          });
        }

        // per-row change-handler
        rowCheckboxes.forEach(cb => cb.addEventListener('change', updateButtons));

        // when select-all-matching toggled, set hidden input and update buttons
        if (selectAllMatching) {
          selectAllMatching.addEventListener('change', function(e){
            if (selectAllInput) selectAllInput.value = e.target.checked ? '1' : '0';
            // If user checks select-all-matching, enable buttons even if no per-row boxes selected
            updateButtons();
          });
        }

        // initial button state on load
        updateButtons();
      })();
    </script>

  {% else %}
    <p style="color:#666;">{% trans "No plant selected or no missing products for the selected plant/filters." %}</p>
  {% endif %}

  <p style="margin-top:1rem;"><a href="{% url 'admin:masters_productplant_changelist' %}" class="button">{% trans "Back to ProductPlant list" %}</a></p>
</div>
{% endblock %}
